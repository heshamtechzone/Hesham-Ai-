<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H.Ai - المساعد الذكي الإسلامي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712035.png">
    <style>
        :root {
            --primary-color: #2E7D32;
            --secondary-color: #1B5E20;
            --text-color: #333;
            --bg-color: #f5f5f5;
            --message-bg: #fff;
            --ai-message-bg: #E8F5E9;
            --user-message-bg: #4CAF50;
            --border-color: #ddd;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --primary-color: #388E3C;
            --secondary-color: #1B5E20;
            --text-color: #f5f5f5;
            --bg-color: #121212;
            --message-bg: #1e1e1e;
            --ai-message-bg: #1B3A20;
            --user-message-bg: #2E7D32;
            --border-color: #444;
            --shadow-color: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo {
            width: 40px;
            height: 40px;
        }

        h1 {
            font-size: 24px;
            color: var(--primary-color);
        }

        .theme-toggle {
            cursor: pointer;
            font-size: 20px;
            color: var(--primary-color);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px var(--shadow-color);
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: var(--bg-color);
        }

        .message {
            margin-bottom: 15px;
            display: flex;
        }

        .message-content {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background-color: var(--user-message-bg);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .ai-message {
            justify-content: flex-start;
        }

        .ai-message .message-content {
            background-color: var(--ai-message-bg);
            color: var(--text-color);
            border-bottom-left-radius: 5px;
        }

        .input-container {
            display: flex;
            padding: 15px;
            background-color: var(--message-bg);
            border-top: 1px solid var(--border-color);
        }

        textarea {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 25px;
            resize: none;
            outline: none;
            font-size: 16px;
            background-color: var(--message-bg);
            color: var(--text-color);
            transition: height 0.2s;
            max-height: 150px;
            overflow-y: auto;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            margin-right: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: var(--secondary-color);
        }

        footer {
            text-align: center;
            padding: 15px 0;
            font-size: 14px;
            color: var(--text-color);
            margin-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* تحسينات للواجهة العربية */
        textarea {
            text-align: right;
            direction: rtl;
        }

        .message-content {
            text-align: right;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .message-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <img src="https://cdn-icons-png.flaticon.com/512/4712/4712035.png" alt="H.Ai Logo" class="logo">
                <h1>H.Ai</h1>
            </div>
            <div class="theme-toggle">
                <i class="fas fa-moon" id="theme-icon"></i>
            </div>
        </header>

        <div class="chat-container">
            <div class="chat-messages" id="chat-messages">
                <div class="message ai-message">
                    <div class="message-content">
                        <p>السلام عليكم ورحمة الله وبركاته<br><br>أنا H.Ai، مساعدك الذكي الذي يقدم معلومات مفيدة وموثوقة وفقًا للمنهج الإسلامي الصحيح.<br><br>كيف يمكنني مساعدتك اليوم؟</p>
                    </div>
                </div>
            </div>

            <div class="input-container">
                <textarea id="user-input" placeholder="اكتب رسالتك هنا..." rows="1"></textarea>
                <button id="send-button"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <footer>
            <p>H.Ai - مساعد ذكي يقدم معلومات دقيقة وفق منهج السلف الصالح</p>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const chatMessages = document.getElementById('chat-messages');
            const userInput = document.getElementById('user-input');
            const sendButton = document.getElementById('send-button');
            const themeIcon = document.getElementById('theme-icon');
            
            // قاعدة المعرفة العقائدية السلفية المحسنة
            const salafiKnowledgeBase = {
                "اين الله": {
                    answer: "الله تعالى فوق السماوات السبع على عرشه استواء يليق بجلاله، كما قال تعالى: ﴿الرَّحْمَٰنُ عَلَى الْعَرْشِ اسْتَوَى﴾ [طه:5]، وقال النبي ﷺ للجارية: 'أين الله؟' قالت: 'في السماء' فقال: 'اعتقها فإنها مؤمنة' (رواه مسلم).",
                    references: [
                        "قال الإمام الذهبي: 'هو العلي الأعلى، العالي فوق خلقه، وفوق كل شيء'",
                        "قال الشيخ ابن باز: 'الله فوق العرش فوق السماوات'",
                        "قال الشيخ ابن عثيمين: 'استواء الله على عرشه حقيقة وليس مجازاً'"
                    ]
                },
                "هل الله في السماء": {
                    answer: "نعم، الله تعالى في السماء فوق العرش، قال الإمام مالك: 'الاستواء معلوم، والكيف مجهول، والإيمان به واجب'.",
                    references: [
                        "قال الإمام ابن تيمية: 'من أنكر أن الله في السماء فهو معطل جهمي'",
                        "قال الشيخ الألباني: 'القول بأن الله في كل مكان كفر صريح'"
                    ]
                },
                "استواء الله على العرش": {
                    answer: "استواء الله على عرشه استواء حقيقي يليق بجلاله من غير تكييف ولا تمثيل، قال تعالى: ﴿ثُمَّ اسْتَوَى عَلَى الْعَرْشِ﴾ في سبع آيات من القرآن.",
                    references: [
                        "قال الإمام الطحاوي: 'والعرش والكرسي حق، وهو مستغن عن العرش وما دونه'",
                        "قال الشيخ الفوزان: 'من أنكر استواء الله على عرشه فهو ضال'"
                    ]
                },
                "صفات الله": {
                    answer: "صفات الله كلها صفات كمال تليق بجلاله من غير تحريف ولا تعطيل ولا تكييف ولا تمثيل، كالاستواء والنزول واليدين والوجه وغيرها.",
                    references: [
                        "قال الإمام ابن القيم: 'أهل السنة يثبتون الصفات وينزهون الله عن مشابهة المخلوقات'",
                        "قال الشيخ صالح آل الشيخ: 'من نفى صفة من الصفات الثابتة بالكتاب والسنة فهو معطل'"
                    ]
                },
                "العقيدة السلفية": {
                    answer: "العقيدة السلفية هي ما كان عليه النبي ﷺ وأصحابه من إثبات ما أثبته الله لنفسه في كتابه أو على لسان رسوله ﷺ من غير تحريف ولا تعطيل ولا تكييف ولا تمثيل.",
                    references: [
                        "قال الإمام أحمد: 'أصول السنة عندنا التمسك بما كان عليه الصحابة'",
                        "قال الشيخ ابن عثيمين: 'السلفي هو من سار على منهج السلف الصالح'"
                    ]
                },
                "التوسل": {
                    answer: "التوسل المشروع هو التوسل بأسماء الله وصفاته، أو بعمل صالح من أعمال المتوسل، أو بدعاء المسلم الحي الحاضر. أما التوسل بذوات الصالحين أو جاههم فبدعة لم تثبت عن النبي ﷺ ولا عن الصحابة.",
                    references: [
                        "قال الشيخ ابن باز: 'التوسل البدعي مثل التوسل بجاه النبي أو بذاته لا يجوز'",
                        "قال الشيخ الألباني: 'التوسل أنواع، فمنه الجائز ومنه الممنوع'"
                    ]
                },
                "الشفاعة": {
                    answer: "الشفاعة أنواع: شفاعة مثبتة يوم القيامة للنبي ﷺ ولغيره من المؤمنين بإذن الله، وشفاعة منفية في الدنيا كالاستشفاع بالأموات والغائبين، قال تعالى: ﴿مَن ذَا الَّذِي يَشْفَعُ عِنْدَهُ إِلاَّ بِإِذْنِهِ﴾ [البقرة:255].",
                    references: [
                        "قال ابن تيمية: 'الشفاعة التي نفاها القرآن ما كان يعتقده المشركون من شفاعة الآلهة بغير إذن الله'",
                        "قال ابن عثيمين: 'شفاعة النبي ﷺ يوم القيامة حق ولكن بشروط'"
                    ]
                }
            };

            // تحسينات الوضع الليلي
            let darkMode = localStorage.getItem('darkMode') === 'true';
            updateTheme();
            
            themeIcon.addEventListener('click', () => {
                darkMode = !darkMode;
                localStorage.setItem('darkMode', darkMode);
                updateTheme();
            });
            
            function updateTheme() {
                document.body.setAttribute('data-theme', darkMode ? 'dark' : 'light');
                themeIcon.className = darkMode ? 'fas fa-sun' : 'fas fa-moon';
            }

            // تحسينات لواجهة المستخدم
            userInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
            
            userInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            sendButton.addEventListener('click', sendMessage);
            
            // دالة محسنة لإضافة الرسائل
            function addMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${role}-message`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                // تحويل النصوص الدينية إلى تنسيق جميل
                const formattedContent = content
                    .replace(/﴿(.*?)﴾/g, '<span class="ayah">$1</span>')
                    .replace(/(رواه \w+)/g, '<em class="hadith-ref">$1</em>')
                    .replace(/(قال \w+:)/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                
                contentDiv.innerHTML = formattedContent;
                messageDiv.appendChild(contentDiv);
                chatMessages.appendChild(messageDiv);
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // دالة محسنة للبحث في القاعدة المعرفية
            function getSalafiAnswer(question) {
                const lowerQuestion = question.toLowerCase();
                
                // البحث المباشر مع تحسينات
                for (const [key, data] of Object.entries(salafiKnowledgeBase)) {
                    const keywords = key.split('|');
                    if (keywords.some(kw => lowerQuestion.includes(kw))) {
                        const randomRef = data.references[Math.floor(Math.random() * data.references.length)];
                        return `${data.answer}<br><br><em class="scholar-quote">${randomRef}</em>`;
                    }
                }
                
                // إجابات ذكية للأسئلة المشابهة
                if (lowerQuestion.includes('عقيد') || lowerQuestion.includes('اعتقاد')) {
                    return salafiKnowledgeBase["العقيدة السلفية"].answer;
                }
                
                if (lowerQuestion.includes('صفة') || lowerQuestion.includes('صفات')) {
                    return salafiKnowledgeBase["صفات الله"].answer;
                }
                
                // إجابات عامة محسنة
                const generalAnswers = [
                    "هذا سؤال مهم، والأولى الرجوع إلى كتب العقيدة السلفية مثل 'شرح الطحاوية' و'العقيدة الواسطية'",
                    "أسأل الله أن يثبتنا على الحق، ويمكنك مراجعة فتاوى العلماء الموثوقين في هذه المسألة",
                    "هذا يحتاج إلى تثبت، ومن أفضل ما يُراجع فيه كتب الشيخ ابن عثيمين وابن باز رحمهما الله",
                    "المرجع في مثل هذه المسائل كتاب الله وسنة رسوله ﷺ بفهم السلف الصالح",
                    "هذا السؤال له تفصيل في كتب العقيدة، وأنصحك بمراجعة 'مجموع فتاوى الشيخ ابن باز' أو 'فتاوى العقيدة' للشيخ ابن عثيمين"
                ];
                
                return generalAnswers[Math.floor(Math.random() * generalAnswers.length)];
            }

            // دالة محسنة لإرسال الرسائل
            async function sendMessage() {
                const message = userInput.value.trim();
                if (!message) return;
                
                addMessage('user', message);
                userInput.value = '';
                userInput.style.height = 'auto';
                
                // عرض مؤشر الكتابة
                const typingIndicator = addMessage('ai', '...');
                
                try {
                    // البحث أولاً في القاعدة المعرفية المحلية
                    const localAnswer = getSalafiAnswer(message);
                    
                    // إذا كانت الإجابة من القاعدة المعرفية كافية
                    if (!localAnswer.includes("هذا سؤال مهم")) {
                        setTimeout(() => {
                            typingIndicator.remove();
                            addMessage('ai', localAnswer);
                        }, 1000 + Math.random() * 2000);
                        return;
                    }
                    
                    // إذا لم تكن كافية، نستخدم API مع معالجة إضافية
                    const response = await fetch('/api/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            prompt: `أنت مساعد إسلامي يتبع منهج السلف. أجب بلغة عربية فصيحة وفق الأدلة الشرعية. السؤال: ${message}`
                        })
                    });
                    
                    const data = await response.json();
                    
                    // معالجة الإجابة من API
                    let aiResponse = '';
                    try {
                        aiResponse = data.candidates[0].content.parts[0].text;
                        
                        // تحسين الإجابة إذا كانت عامة
                        if (message.includes('اين الله') || message.includes('مكان الله')) {
                            aiResponse = salafiKnowledgeBase["اين الله"].answer;
                        }
                    } catch (e) {
                        aiResponse = localAnswer;
                    }
                    
                    typingIndicator.remove();
                    addMessage('ai', aiResponse);
                } catch (error) {
                    console.error('Error:', error);
                    typingIndicator.remove();
                    addMessage('ai', "عذرًا، حدث خطأ في الاتصال. جرب سؤالاً آخر أو حاول لاحقًا.");
                }
            }

            // الكشف التلقائي عن الوضع المظلم
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                darkMode = true;
                updateTheme();
            }
            
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', e => {
                darkMode = e.matches;
                updateTheme();
            });
        });
    </script>
</body>
</html>
